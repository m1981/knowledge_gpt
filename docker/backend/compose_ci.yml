version: '3.4'

services:
  console:
    image: ${TESTS_IMAGE:?err}
    volumes:
      - ${SOURCE_DIR:?err}/knowledge_gpt:/app/knowledge_gpt
      - ${SOURCE_DIR:?err}/tests:/app/tests
      - ${SOURCE_DIR:?err}/resources:/app/resources
      - ${SOURCE_DIR:?err}/poetry.lock:/app/poetry.lock
      - ${SOURCE_DIR:?err}/pyproject.toml:/app/pyproject.toml
    command: ["bash"]

  tests-ut:
    image: ${TESTS_IMAGE:?err}
    volumes:
      - ${SOURCE_DIR:?err}/knowledge_gpt:/app/knowledge_gpt
      - ${SOURCE_DIR:?err}/tests:/app/tests
      - ${SOURCE_DIR:?err}/resources:/app/resources
      - ${SOURCE_DIR:?err}/.coveragerc:/app/.coveragerc
    command: >
      bash -c "coverage run -m pytest . --maxfail=3
      && coverage report
      && coverage html --fail-under=55
      || (echo ERROR Tests failed or Coverage under target! && exit 1)"


  dev-server:
    image: ${TESTS_IMAGE:?err}
    ports:
      - "5173:5173"
    environment:
      - VITE_FIREBASE_AUTH_EMULATOR_HOST=firebase-emulators:9099
      - VITE_FIRESTORE_EMULATOR_HOST=firebase-emulators:8080
    volumes:
      - ${SOURCE_DIR:?err}:/app
      - /app/node_modules
    command: ["sh", "-c", "yarn dev"]
